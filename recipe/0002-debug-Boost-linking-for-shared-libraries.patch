From 67c73fa7627b91c4c40dae32bd619d0c925cfb66 Mon Sep 17 00:00:00 2001
From: Julien Jerphanion <git@jjerphan.xyz>
Date: Mon, 12 Jun 2023 09:31:05 +0200
Subject: [PATCH] debug: Boost linking for shared libraries

Signed-off-by: Julien Jerphanion <git@jjerphan.xyz>
---
 CMake/folly-config.cmake.in |  2 +-
 CMake/folly-deps.cmake      | 22 +++++++++++++++++++++-
 CMakeLists.txt              |  9 +++++++--
 3 files changed, 29 insertions(+), 4 deletions(-)

diff --git a/CMake/folly-config.cmake.in b/CMake/folly-config.cmake.in
index 0b96f0a10..f67146869 100644
--- a/CMake/folly-config.cmake.in
+++ b/CMake/folly-config.cmake.in
@@ -32,7 +32,7 @@ set(FOLLY_LIBRARIES Folly::folly)
 find_dependency(fmt)
 
 set(Boost_USE_STATIC_LIBS "@FOLLY_BOOST_LINK_STATIC@")
-find_dependency(Boost 1.51.0 MODULE
+find_dependency(Boost
   COMPONENTS
     context
     filesystem
diff --git a/CMake/folly-deps.cmake b/CMake/folly-deps.cmake
index 989259a87..d40342d41 100644
--- a/CMake/folly-deps.cmake
+++ b/CMake/folly-deps.cmake
@@ -35,7 +35,10 @@ else()
 endif()
 set(Boost_USE_STATIC_LIBS "${FOLLY_BOOST_LINK_STATIC}")
 
-find_package(Boost 1.51.0 MODULE
+message(STATUS "FOLLY_BOOST_LINK_STATIC: ${FOLLY_BOOST_LINK_STATIC}")
+message(STATUS "Boost_USE_STATIC_LIBS: ${Boost_USE_STATIC_LIBS}")
+
+find_package(Boost
   COMPONENTS
     context
     filesystem
@@ -45,9 +48,22 @@ find_package(Boost 1.51.0 MODULE
     thread
   REQUIRED
 )
+
+set(Boost_LIBRARIES
+    Boost::boost
+    Boost::context
+    Boost::filesystem
+    Boost::program_options
+    Boost::regex
+    Boost::system
+    Boost::thread
+)
+
 list(APPEND FOLLY_LINK_LIBRARIES ${Boost_LIBRARIES})
 list(APPEND FOLLY_INCLUDE_DIRECTORIES ${Boost_INCLUDE_DIRS})
 
+message(STATUS "FOLLY_LINK_LIBRARIES after BOOST inclusion     : ${FOLLY_LINK_LIBRARIES}")
+
 find_package(DoubleConversion MODULE REQUIRED)
 list(APPEND FOLLY_LINK_LIBRARIES ${DOUBLE_CONVERSION_LIBRARY})
 list(APPEND FOLLY_INCLUDE_DIRECTORIES ${DOUBLE_CONVERSION_INCLUDE_DIR})
@@ -307,6 +323,10 @@ endif()
 target_link_libraries(folly_deps INTERFACE fmt::fmt)
 
 list(REMOVE_DUPLICATES FOLLY_INCLUDE_DIRECTORIES)
+
+message(STATUS "Final FOLLY_LINK_LIBRARIES     : ${FOLLY_LINK_LIBRARIES}")
+message(STATUS "Final FOLLY_INCLUDE_DIRECTORIES: ${FOLLY_INCLUDE_DIRECTORIES}")
+
 target_include_directories(folly_deps INTERFACE ${FOLLY_INCLUDE_DIRECTORIES})
 target_link_libraries(folly_deps INTERFACE
   ${FOLLY_LINK_LIBRARIES}
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 85ba70d3b..5a5f79855 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -421,6 +421,8 @@ target_compile_definitions(folly_base
 
 set(FOLLY_INSTALL_TARGETS folly folly_deps)
 
+message(STATUS "Global -- folly_deps: ${folly_deps}")
+
 option(PYTHON_EXTENSIONS
   "Build Python Bindings for Folly, requires Cython and (BUILD_SHARED_LIBS=ON)"
   OFF
@@ -440,10 +442,13 @@ add_library(folly_test_util
   ${FOLLY_DIR}/test/DeterministicSchedule.cpp
   ${FOLLY_DIR}/test/JsonTestUtil.cpp
 )
+
+message(STATUS "Global -- Boost_LIBRARIES: ${Boost_LIBRARIES}")
+
 set_property(TARGET folly_test_util PROPERTY VERSION ${PACKAGE_VERSION})
 target_link_libraries(folly_test_util
   PUBLIC
-    ${BOOST_LIBRARIES}
+    ${Boost_LIBRARIES}
     folly
     ${LIBGMOCK_LIBRARIES}
 )
@@ -595,7 +600,7 @@ if (BUILD_TESTS OR BUILD_BENCHMARKS)
   )
   target_link_libraries(folly_test_support
     PUBLIC
-      ${BOOST_LIBRARIES}
+      ${Boost_LIBRARIES}
       follybenchmark
       folly
       ${LIBGMOCK_LIBRARIES}
-- 
2.40.0

